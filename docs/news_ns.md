## Overview

This document describes the **north star vision** for news collection and fact extraction in the Fantasy Premier League assistant.  
It focuses on **what** the system should do (capabilities and data structures), not **how** it is implemented.  
For the overall product vision, see **"Product North Star"** at `docs/product_ns.md`.

The news system transforms raw news articles into structured, player-specific facts that inform predictions about player availability and form. Every fact must be traceable back to its source article, enabling users to verify claims and understand the evidence behind predictions.

---

## 1. Data Model

### NewsFact

A `NewsFact` represents a single extracted piece of information about a Premier League player from a news article:

- `player_id: int` — FPL player identifier
- `news_id: int` — Source article identifier (from the news provider)
- `next_gameweek: int` — The gameweek this fact is relevant for
- `fact: str` — Short extract from the article about this specific player
- `form: float` — Impact on player form, range `[-1, 1]`
  - `-1`: Certain evidence the player will score zero points next match
  - `+1`: Strong evidence the player will score many points next match
- `availability: float` — Impact on player availability, range `[-1, 1]`
  - `-1`: Certain evidence the player will not start next match
  - `+1`: Strong evidence the player will start next match with high confidence

**Purpose**: Facts inform predictions by providing qualitative context that complements statistical models. They help answer questions like "Why is this player's availability uncertain?" or "What recent news supports this form projection?"

### Raw News

Raw news articles are stored with full metadata:

- `id: int` — News provider identifier
- `url: str` — Source article URL
- `date: str` — Publication date
- `title: str` — Article title
- `summary: str` — Article summary/description
- `body: str` — Full article HTML/text content

**Purpose**: Enable users to verify facts by reading the original source. The system must support lookup from `news_id` to full raw article.

---

## 2. Data Storage Structure

News data is organized hierarchically by gameweek, collection source, processing layer, and article ID:

```
data/2025-2026/news/<gameweek_id>/<news_collection>/<layer>/<news_id>.json
```

**Components**:

- `gameweek_id`: ID of the next gameweek this news is relevant for (determined from publication date and gameweek deadlines)
- `news_collection`: Data source identifier (e.g., `"fpl_fantasy"`, `"fpl_tactics"`). Initially only `"fpl_fantasy"` is supported.
- `layer`: Processing stage
  - `"raw"`: Original fetched data from the news provider
  - `"facts"`: Extracted facts generated by LLM (future layers may include `"validated"`, `"merged"`, etc.)
- `news_id`: Provider-assigned article identifier

**Rationale**: This structure supports:
- Time-based organization (facts organized by target gameweek for efficient filtering)
- Multi-source aggregation (different collections can be merged)
- Processing pipeline visibility (raw → facts → validated)
- Efficient lookups by gameweek, source, or article ID

**Note**: Facts are never expired or deleted. The primary use case is reading news and facts for the most recent available gameweek, but historical facts remain accessible for analysis.

---

## 3. News Collection

### Purpose

The news collection system fetches articles from external sources and persists them in the `raw` layer.

### Current Implementation

The collection infrastructure exists in `src/fpl/loader/news/pl.py`:

- Fetches articles from the Premier League Fantasy API (The Scout content)
- Paginates through recent articles until encountering known items
- Saves articles to `data/2025-2026/news/<news_id>.json` (current flat structure)
- Provides utilities to list and filter saved articles

**Future Extensions**: Additional data feeds can be added (e.g., `fpl_tactics`, team press conferences, injury reports) by implementing similar loaders that write to different `news_collection` subdirectories.

---

## 4. LLM Fact Extraction

### Purpose

Transform raw news articles into structured `NewsFact` objects by analyzing article text and extracting player-specific information with quantified impact scores.

### Process

1. **Input**: Raw news article (title, summary, body) and target gameweek (determined from publication date and gameweek deadlines)
2. **LLM Processing**: Gemini model analyzes the article and extracts:
   - All mentioned Premier League players
   - Relevant facts about each player
   - Impact scores (`form` and `availability`) for each fact
3. **Output**: List of `NewsFact` objects (one per player mentioned), each assigned the target gameweek from step 1

**Note**: Gameweek assignment is trivial — determined automatically when fetching news based on publication date and gameweek deadlines. The LLM does not infer gameweek from article content.

### Prompt Design

The LLM prompt will be designed iteratively:
- Start with a simple JSON schema for structured output
- Refine based on quality of extracted facts
- Incorporate examples of good vs. bad fact extraction as needed
- Handle ambiguous or conflicting information appropriately

This iterative approach allows the system to improve over time without requiring upfront perfect prompt engineering.

### Player Name Mapping

**Challenge**: The LLM returns player names (e.g., "Mohamed Salah", "Haaland"), but we need FPL `player_id` values.

**Approach**: Two-step mapping:

1. **LLM Extraction**: Model returns facts with player names as strings
2. **Post-Processing**: Separate mapping step converts names → `player_id` using:
   - Primary: Existing `Query.player_by_name()` / `Query.players_by_name()` methods with fuzzy matching
   - Fallback: Whitelist for corner cases where fuzzy matching fails (e.g., ambiguous names, typos, or name variations not covered by the Query methods)

**Rationale**: This separation allows:
- Changing mapping logic without re-running expensive LLM calls
- Caching LLM results independently of mapping decisions
- Better control and debugging of name resolution
- Leveraging existing Query infrastructure for most cases, with manual override only when needed

### Caching

LLM fact extraction results are cached to avoid redundant API calls:

- **Cache Key**: Based on article content (e.g., hash of title + body)
- **Cache Storage**: Separate from raw news storage
- **Cache Invalidation**: When article content changes (detected via date/timestamp comparison)

**Rationale**: Caching is especially valuable with the two-step mapping approach, as mapping logic can be refined without re-extracting facts.

---

## 5. Integration with Core Models

### Query Facade Extension

The `Query` class in `src/fpl/models/immutable.py` is extended to provide access to news facts and raw articles:

**News Facts**:
- `news_facts_by_player(player_id: int, gameweek: int | None = None) -> list[NewsFact]` — Get all facts for a player, optionally filtered by gameweek
- `news_facts_by_gameweek(gameweek: int) -> list[NewsFact]` — Get all facts relevant to a gameweek

**Raw News**:
- `raw_news(news_id: int) -> dict` — Get full raw article by ID
- `raw_news_by_gameweek(gameweek: int) -> list[dict]` — Get all raw articles for a gameweek

**Rationale**: Following the confirmability principle — users can drill from facts → source articles to verify claims.

### PlayerTotalPrediction Extension

The `PlayerTotalPrediction` class in `src/fpl/models/prediction.py` is extended with:

- `news_facts: list[NewsFact]` property — Returns all available facts for this player relevant to the prediction horizon

**Rationale**: Predictions expose the evidence that supports them. Facts inform availability and form judgments, so they must be accessible alongside point projections.

### Fact Deduplication

Duplicate facts are allowed — multiple sources can reinforce a claim, and the same fact appearing in different articles provides additional evidence. No automatic merging or deduplication is performed.

---

## 7. Key Paths

- News loader: `src/fpl/loader/news/pl.py`
- Query facade: `src/fpl/models/immutable.py` (class `Query`)
- Prediction models: `src/fpl/models/prediction.py` (class `PlayerTotalPrediction`)
- Collection system: `src/fpl/collection.py`

---

## 8. Related Docs

- **"Product North Star"** at `docs/product_ns.md` — Overall product vision and confirmability principle
- **"Documentation Standards"** at `docs/metadoc.md` — Documentation style and structure guidelines

